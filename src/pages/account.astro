---
import Layout from '../layouts/Layout.astro';
import { User, Package, Heart, LogOut } from 'lucide-astro';
---

<Layout title="My Account">
  <section class="section-padding">
    <div class="container account-page">
      <div class="account-header">
        <h1>My Account</h1>
        <p id="user-email">Welcome back!</p>
      </div>

      <div class="account-grid">
        <aside class="account-sidebar">
          <nav class="account-nav">
            <a href="#orders" class="active"><Package size={20} /> My Orders</a>
            <a href="#favorites"><Heart size={20} /> My Wishlist</a>
            <button id="logout-btn" class="logout-link"><LogOut size={20} /> Sign Out</button>
          </nav>
        </aside>

        <main class="account-content">
          <div id="orders" class="tab-content active">
            <h2>Order History</h2>
            <div class="empty-state">
              <Package size={48} />
              <p>You haven't placed any orders yet.</p>
              <a href="/products" class="btn btn-primary">Start Shopping</a>
            </div>
          </div>

          <div id="favorites" class="tab-content">
            <h2>My Wishlist</h2>
            <div id="favorites-list" class="empty-state">
              <Heart size={48} />
              <p>Your wishlist is empty.</p>
              <a href="/products" class="btn btn-primary">Browse Products</a>
            </div>
          </div>
        </main>
      </div>
    </div>
  </section>
</Layout>

<style>
  .account-page {
    max-width: 1000px;
  }

  .account-header {
    margin-bottom: 3rem;
    text-align: center;
  }

  .account-grid {
    display: grid;
    grid-template-columns: 250px 1fr;
    gap: 4rem;
    align-items: start;
  }

  .account-nav {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    background: var(--surface);
    padding: 1rem;
    border-radius: var(--radius);
    border: 1px solid var(--border);
  }

  .account-nav a, .logout-link {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border-radius: calc(var(--radius) / 2);
    color: var(--text-light);
    font-weight: 500;
    transition: var(--transition);
    text-align: left;
    width: 100%;
    background: none;
    border: none;
    cursor: pointer;
  }

  .account-nav a:hover, .account-nav a.active {
    background: var(--primary);
    color: white;
  }

  .logout-link {
    margin-top: 1rem;
    border-top: 1px solid var(--border);
    border-radius: 0;
    color: #e63946;
  }

  .logout-link:hover {
    background: rgba(230, 57, 70, 0.1);
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  .tab-content h2 {
    margin-bottom: 2rem;
  }

  .empty-state {
    text-align: center;
    padding: 5rem 2rem;
    background: var(--surface);
    border-radius: var(--radius);
    border: 2px dashed var(--border);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
  }

  .empty-state svg {
    color: var(--border);
  }

  @media (max-width: 768px) {
    .account-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  import { favoritesItems } from '../stores/favoritesStore';

  // Check if user is logged in
  window.addEventListener('load', () => {
    // @ts-ignore
    if (window.netlifyIdentity) {
      // @ts-ignore
      const user = window.netlifyIdentity.currentUser();
      if (!user) {
        window.location.href = '/';
        // @ts-ignore
        window.netlifyIdentity.open('login');
      } else {
        const emailEl = document.getElementById('user-email');
        if (emailEl) emailEl.textContent = `LoggedIn as: ${user.email}`;
      }
    }

    // Render Favorites
    const favList = document.getElementById('favorites-list');
    const items = favoritesItems.get();

    if (items.length > 0 && favList) {
      favList.innerHTML = `
        <div class="favorites-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem; width: 100%;">
          ${items.map(item => `
            <div class="fav-card" style="background: white; border-radius: 12px; overflow: hidden; border: 1px solid #eee;">
              <img src="${item.image}" style="width: 100%; aspect-ratio: 1; object-fit: cover;">
              <div style="padding: 1rem;">
                <h4 style="margin: 0 0 0.5rem 0;">${item.title}</h4>
                <p style="color: var(--primary); font-weight: 700; margin: 0;">$${item.price} TTD</p>
              </div>
            </div>
          `).join('')}
        </div>
      `;
      favList.style.border = 'none';
      favList.style.background = 'none';
      favList.style.padding = '0';
    }
  });

  // Tab switching
  const tabs = document.querySelectorAll('.account-nav a');
  const contents = document.querySelectorAll('.tab-content');

  tabs.forEach(tab => {
    tab.addEventListener('click', (e) => {
      e.preventDefault();
      const targetId = tab.getAttribute('href')?.substring(1);
      
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      contents.forEach(content => {
        content.classList.remove('active');
        if (content.id === targetId) content.classList.add('active');
      });
    });
  });

  // Logout
  const logoutBtn = document.getElementById('logout-btn');
  logoutBtn?.addEventListener('click', () => {
    // @ts-ignore
    window.netlifyIdentity.logout();
  });
</script>
